Imports System.Threading
Imports System.ComponentModel ' For Description attribute
Imports System.Windows.Forms

''' <summary>
''' UI State Machine - Maps global states to UI states
''' Subscribes to GlobalStateMachine and marshals events to UI thread
''' Ownership: Owns UI state representation, MainForm subscribes to this
''' Thread-Safe: All StateChanged events fire on UI thread
''' </summary>
Public Class UIStateMachine
    Implements IStateMachine(Of UIState)

    ' Thread-safe state storage
    Private _currentState As Integer = UIState.Uninitialized

    ' Lock for state transitions
    Private ReadOnly _stateLock As New Object()

    ' Transition counter for generating unique TransitionIDs (State Registry Pattern)
    Private _transitionCounter As Integer = 0

    ' Reference to GlobalStateMachine (subscribe to its transitions)
    Private ReadOnly _globalStateMachine As GlobalStateMachine

    ' Reference to UI Control (for InvokeRequired/BeginInvoke)
    Private ReadOnly _uiControl As Control

    ' StateChanged event (ALWAYS fires on UI thread)
    Public Event StateChanged As EventHandler(Of StateChangedEventArgs(Of UIState)) Implements IStateMachine(Of UIState).StateChanged

#Region "Properties"

    ''' <summary>
    ''' Gets the current state (thread-safe read)
    ''' </summary>
    Public ReadOnly Property CurrentState As UIState Implements IStateMachine(Of UIState).CurrentState
        Get
            Return CType(Interlocked.CompareExchange(_currentState, 0, 0), UIState)
        End Get
    End Property

#End Region

#Region "Constructor"

    ''' <summary>
    ''' Creates a new UIStateMachine
    ''' </summary>
    ''' <param name="globalStateMachine">GlobalStateMachine to subscribe to</param>
    ''' <param name="uiControl">UI Control for thread marshaling (typically MainForm)</param>
    Public Sub New(globalStateMachine As GlobalStateMachine, uiControl As Control)
        If globalStateMachine Is Nothing Then Throw New ArgumentNullException(NameOf(globalStateMachine))
        If uiControl Is Nothing Then Throw New ArgumentNullException(NameOf(uiControl))

        _globalStateMachine = globalStateMachine
        _uiControl = uiControl

        ' Initialize in Uninitialized state
        Interlocked.Exchange(_currentState, UIState.Uninitialized)

        ' Subscribe to GlobalStateMachine transitions
        AddHandler _globalStateMachine.StateChanged, AddressOf OnGlobalStateChanged

        Utils.Logger.Instance.Info("UIStateMachine created and subscribed to GlobalStateMachine", "UIStateMachine")
    End Sub

#End Region

#Region "Public Methods"

    ''' <summary>
    ''' Attempts to transition to a new state
    ''' </summary>
    ''' <param name="newState">Target state</param>
    ''' <param name="reason">Reason for transition</param>
    ''' <returns>True if transition succeeded</returns>
    Public Function TransitionTo(newState As UIState, reason As String) As Boolean Implements IStateMachine(Of UIState).TransitionTo
        SyncLock _stateLock
            Dim oldState = CurrentState

            ' Check if transition is valid
            If Not IsValidTransition(oldState, newState) Then
                Utils.Logger.Instance.Warning($"UIStateMachine: Invalid transition {oldState} → {newState} (Reason: {reason})", "UIStateMachine")
                Return False
            End If

            ' Perform state entry/exit actions
            OnStateExiting(oldState, newState)

            ' Update state (thread-safe)
            Interlocked.Exchange(_currentState, newState)

            OnStateEntering(oldState, newState)


            ' Generate TransitionID for State Registry Pattern
            Dim transitionNum = System.Threading.Interlocked.Increment(_transitionCounter)
            Dim oldStateUID = GetStateUID(oldState)
            Dim newStateUID = GetStateUID(newState)
            Dim transitionID = $"UI_T{transitionNum:D2}_{oldStateUID}_TO_{newStateUID}"

            ' Create event args with State Registry Pattern support
            Dim args As New StateChangedEventArgs(Of UIState)(
                oldState, newState, reason, transitionID, oldStateUID, newStateUID)

            ' ✅ LOG TRANSITION (State Registry Pattern - grep-friendly format)
            Utils.Logger.Instance.Info(args.ToString(), "UIStateMachine")

            ' Fire event on UI thread (CRITICAL for thread safety!)
            FireEventOnUIThread(args)

            Return True
        End SyncLock
    End Function

    ''' <summary>
    ''' Checks if a state transition is valid
    ''' </summary>
    Public Function IsValidTransition(fromState As UIState, toState As UIState) As Boolean Implements IStateMachine(Of UIState).IsValidTransition
        ' Same state is always valid
        If fromState = toState Then Return True

        ' UI state machine is fairly permissive (follows global state)
        Select Case fromState
            Case UIState.Uninitialized
                ' Can transition to any state (initialization)
                Return True

            Case UIState.IdleUI
                ' Can transition to any active state
                Return toState = UIState.RecordingUI OrElse
                       toState = UIState.PlayingUI OrElse
                       toState = UIState.ErrorUI

            Case UIState.RecordingUI
                ' Can go to Idle or Error
                Return toState = UIState.IdleUI OrElse
                       toState = UIState.ErrorUI

            Case UIState.PlayingUI
                ' Can go to Idle or Error
                Return toState = UIState.IdleUI OrElse
                       toState = UIState.ErrorUI

            Case UIState.ErrorUI
                ' Can recover to Idle
                Return toState = UIState.IdleUI

            Case Else
                Return False
        End Select
    End Function

#End Region

#Region "Private Methods - GlobalStateMachine Integration"

    ''' <summary>
    ''' Responds to GlobalStateMachine state changes
    ''' Maps global states to UI states
    ''' NOTE: This may be called on ANY thread (event fired by GlobalStateMachine)
    ''' </summary>
    Private Sub OnGlobalStateChanged(sender As Object, e As StateChangedEventArgs(Of GlobalState))
        ' Map global state to UI state
        ' This mapping is simple: we collapse some global states for UI purposes
        Dim targetUIState As UIState

        Select Case e.NewState
            Case GlobalState.Uninitialized
                targetUIState = UIState.Uninitialized

            Case GlobalState.Idle
                targetUIState = UIState.IdleUI

            Case GlobalState.Arming, GlobalState.Armed, GlobalState.Recording, GlobalState.Stopping
                ' All recording-related states map to RecordingUI
                targetUIState = UIState.RecordingUI

            Case GlobalState.Playing
                targetUIState = UIState.PlayingUI

            Case GlobalState.Error
                targetUIState = UIState.ErrorUI

            Case Else
                targetUIState = UIState.IdleUI
        End Select

        ' Transition to target UI state
        TransitionTo(targetUIState, $"Global: {e.NewState}")
    End Sub

    ''' <summary>
    ''' Fires StateChanged event on UI thread (thread-safe marshaling)
    ''' </summary>
    Private Sub FireEventOnUIThread(args As StateChangedEventArgs(Of UIState))
        ' Check if we need to marshal to UI thread
        If _uiControl.InvokeRequired Then
            ' We're NOT on UI thread - marshal using BeginInvoke (non-blocking)
            _uiControl.BeginInvoke(Sub()
                                       ' Now we're on UI thread - fire event
                                       RaiseEvent StateChanged(Me, args)
                                   End Sub)
        Else
            ' We're already on UI thread - fire directly
            RaiseEvent StateChanged(Me, args)
        End If
    End Sub

    ''' <summary>
    ''' Called when exiting a state
    ''' </summary>
    Private Sub OnStateExiting(oldState As UIState, newState As UIState)
        ' UI state machine has minimal entry/exit actions
        ' MainForm will handle actual UI updates by subscribing to StateChanged
    End Sub

    ''' <summary>
    ''' Called when entering a state
    ''' </summary>
    Private Sub OnStateEntering(oldState As UIState, newState As UIState)
        ' UI state machine has minimal entry/exit actions
        ' MainForm will handle actual UI updates by subscribing to StateChanged

        Select Case newState
            Case UIState.IdleUI
                ' Entered idle UI state

            Case UIState.RecordingUI
                ' Entered recording UI state

            Case UIState.PlayingUI
                ' Entered playback UI state

            Case UIState.ErrorUI
                ' Entered error UI state

        End Select
    End Sub

    ''' <summary>
    ''' Gets the UID for a state from its Description attribute (State Registry Pattern)
    ''' </summary>
    Private Shared Function GetStateUID(state As UIState) As String
        Dim field = GetType(UIState).GetField(state.ToString())
        If field Is Nothing Then Return state.ToString()

        Dim attr = CType(Attribute.GetCustomAttribute(field, GetType(System.ComponentModel.DescriptionAttribute)),
                        System.ComponentModel.DescriptionAttribute)
        Return If(attr?.Description, state.ToString())
    End Function

#End Region

End Class

''' <summary>
''' UI-specific states
''' These states represent the UI's view of the system
''' Simplified from GlobalState for UI purposes
''' UIDs follow format: UI_{STATE} for State Registry Pattern
''' </summary>
Public Enum UIState
    ''' <summary>UI not yet initialized</summary>
    <Description("UI_UNINITIALIZED")>
    Uninitialized = 0

    ''' <summary>UI in idle state (buttons enabled for recording/playback)</summary>
    <Description("UI_IDLE")>
    IdleUI = 1

    ''' <summary>UI in recording state (stop button enabled, recording indicator shown)</summary>
    <Description("UI_RECORDING")>
    RecordingUI = 2

    ''' <summary>UI in playback state (stop button enabled, playback indicator shown)</summary>
    <Description("UI_PLAYING")>
    PlayingUI = 3

    ''' <summary>UI in error state (error message shown, recovery options available)</summary>
    <Description("UI_ERROR")>
    ErrorUI = 4
End Enum
