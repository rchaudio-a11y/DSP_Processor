# Complete DSP Pipeline Architecture - Definitive Specification

## ?? **COMPLETE SIGNAL FLOW**

```
??????????????????????????????????????????????????????????????????????????
?                         INPUT SOURCES                                   ?
??????????????????????????????????????????????????????????????????????????

????????????????        ????????????????        ????????????????
?  Microphone  ?   OR   ?  File        ?   OR   ?  Both (Mix)  ?
?  (WaveIn/    ?        ?  (Audio      ?        ?  (Future)    ?
?   WASAPI)    ?        ?   FileReader)?        ?              ?
????????????????        ????????????????        ????????????????
       ?                       ?                       ?
       ?????????????????????????????????????????????????
                               ?
                    ???????????????????????
                    ?  Recording Manager  ?
                    ?  OR AudioRouter     ?
                    ?  (Input Engines)    ?
                    ???????????????????????
                               ?
                               ?
??????????????????????????????????????????????????????????????????????????
?                    ? DSP PIPELINE BOUNDARY START ?                    ?
??????????????????????????????????????????????????????????????????????????
                               ?
                    ???????????????????????
                    ?  INPUT MONITOR      ? ? PARALLEL TAP (Non-blocking)
                    ?  (Parallel Buffer)  ?   Shows RAW input
                    ???????????????????????
                               ?
                    ???????????????????????????????
                    ?  PRE-GAIN STAGE             ?
                    ?  • Input Gain Control       ?
                    ?  • Input Pan                ?
                    ?  • Pre-DSP Level Adjustment ?
                    ???????????????????????????????
                               ?
                    ???????????????????????
                    ?  PRE-GAIN TAP       ? ? PARALLEL TAP
                    ?  (Parallel Buffer)  ?   Shows after input gain
                    ???????????????????????
                               ?
                    ???????????????????????????????
                    ?  FILTER STAGE               ?
                    ?  • HPF (High-Pass Filter)   ?
                    ?  • LPF (Low-Pass Filter)    ?
                    ?  • Bypass Option            ?
                    ???????????????????????????????
                               ?
                    ???????????????????????
                    ?  POST-FILTER TAP    ? ? PARALLEL TAP
                    ?  (Parallel Buffer)  ?   Shows after filters
                    ???????????????????????
                               ?
                    ???????????????????????????????
                    ?  EQ SPLITTER                ?
                    ?  Split into 5 bands:        ?
                    ?  • Sub   (20-60 Hz)         ?
                    ?  • Bass  (60-250 Hz)        ?
                    ?  • Mid   (250-2k Hz)        ?
                    ?  • Treble (2k-6k Hz)        ?
                    ?  • Air   (6k-20k Hz)        ?
                    ???????????????????????????????
                               ?
                    ???????????????????????????????
                    ?  5-BAND EQ PROCESSING       ?
                    ?  ???????????????????????    ?
                    ?  ?  Sub EQ + Tap       ?    ? ? Per-band TAP
                    ?  ???????????????????????    ?
                    ?  ?  Bass EQ + Tap      ?    ? ? Per-band TAP
                    ?  ???????????????????????    ?
                    ?  ?  Mid EQ + Tap       ?    ? ? Per-band TAP
                    ?  ???????????????????????    ?
                    ?  ?  Treble EQ + Tap    ?    ? ? Per-band TAP
                    ?  ???????????????????????    ?
                    ?  ?  Air EQ + Tap       ?    ? ? Per-band TAP
                    ?  ???????????????????????    ?
                    ?  (Future: Compressor,       ?
                    ?   Limiter per band)         ?
                    ???????????????????????????????
                               ?
                    ???????????????????????????????
                    ?  EQ MIXER                   ?
                    ?  Combine all 5 bands back   ?
                    ?  • Per-band levels          ?
                    ?  • Crossover slopes         ?
                    ???????????????????????????????
                               ?
                    ???????????????????????
                    ?  POST-EQ TAP        ? ? PARALLEL TAP
                    ?  (Parallel Buffer)  ?   Shows combined EQ output
                    ???????????????????????
                               ?
                    ???????????????????????????????
                    ?  OUTPUT GAIN STAGE          ?
                    ?  • Master Volume            ?
                    ?  • Output Pan               ?
                    ?  • Stereo Width             ?
                    ???????????????????????????????
                               ?
                    ???????????????????????
                    ?  POST-GAIN TAP      ? ? PARALLEL TAP
                    ?  (Parallel Buffer)  ?   Shows final processed audio
                    ???????????????????????
                               ?
                    ???????????????????????
                    ?  OUTPUT MONITOR     ? ? PARALLEL TAP
                    ?  (Parallel Buffer)  ?   Shows what goes to output
                    ???????????????????????
                               ?
??????????????????????????????????????????????????????????????????????????
?                     ? DSP PIPELINE BOUNDARY END ?                     ?
??????????????????????????????????????????????????????????????????????????
                               ?
                    ???????????????????????????????
                    ?  OUTPUT ROUTING             ?
                    ?  (Selectable)               ?
                    ?  ??????????????????????     ?
                    ?  ?  To Recorder       ? OR  ?
                    ?  ?  (WAV File)        ?     ?
                    ?  ??????????????????????     ?
                    ?  ?  To Speakers       ? OR  ?
                    ?  ?  (WaveOut)         ?     ?
                    ?  ??????????????????????     ?
                    ?  ?  Both              ?     ?
                    ?  ?  (Monitor + Record)?     ?
                    ?  ??????????????????????     ?
                    ???????????????????????????????
```

---

## **?? CURRENT IMPLEMENTATION STATUS**

### **? IMPLEMENTED (Phase 2 - Current):**

```
Input (Mic/File)
    ?
RecordingManager / AudioRouter
    ?
DSPThread
    ?
INPUT MONITOR (Parallel Buffer) ?
    ?
PRE-GAIN STAGE (GainProcessor) ?
    ?
POST-GAIN TAP (Parallel Buffer) ? ? CURRENT: Used for meters
    ?
OUTPUT MONITOR (Parallel Buffer) ?
    ?
Output (Recorder / WaveOut)
```

### **?? TO BE IMPLEMENTED (Future Phases):**

- ? POST-FILTER TAP
- ? FILTER STAGE (HPF/LPF)
- ? EQ SPLITTER
- ? 5-BAND EQ PROCESSING
- ? PER-BAND TAPS
- ? EQ MIXER
- ? POST-EQ TAP
- ? OUTPUT GAIN STAGE (separate from input gain)
- ? STEREO WIDTH CONTROL

---

## **?? KEY ARCHITECTURAL PRINCIPLES**

### **1. DSP Pipeline Boundaries**

**START:** Right after input engine (RecordingManager/AudioRouter)  
**END:** Right before output engine (Recorder/WaveOut)

**Input Engines:**
- RecordingManager (for microphone)
- AudioRouter (for file playback)
- Future: Input mixer (for both)

**Output Engines:**
- RecordingEngine (WAV writer)
- WaveOutEvent (speaker output)
- Future: Output router (selectable)

### **2. Parallel Tap Point Pattern**

**Every DSP stage has a parallel monitoring buffer:**

```vb
' PATTERN: Non-blocking tap point
Processor.SetMonitorOutputCallback(
    Sub(buffer As AudioBuffer)
        ' Write to parallel monitor buffer (non-blocking)
        monitorBuffer.Write(buffer.Buffer, 0, buffer.ByteCount)
    End Sub
)
```

**Why Parallel?**
- ? Non-blocking (doesn't slow down audio thread)
- ? Independent read/write (meters don't compete with output)
- ? Consistent pattern for all stages

### **3. Signal Flow Invariants**

**Rule 1:** Audio ALWAYS flows through DSP pipeline (no bypass at pipeline level)  
**Rule 2:** Each stage can be bypassed INTERNALLY (e.g., filter bypass)  
**Rule 3:** Tap points are ALWAYS active (even when stage is bypassed)  
**Rule 4:** DSP processing is ASYNCHRONOUS (worker thread)  
**Rule 5:** Input/Output are SYNCHRONOUS (callback-driven)

---

## **?? DSP STAGE SPECIFICATIONS**

### **Stage 1: Input Monitor**
- **Purpose:** Shows raw input audio (before any processing)
- **Buffer Size:** 2 seconds (176,400 bytes at 44.1kHz stereo)
- **Used For:** Input meters, FFT analysis
- **Status:** ? Implemented

### **Stage 2: Pre-Gain Stage**
- **Purpose:** Input level control, pan
- **Controls:**
  - Gain: -60dB to +20dB
  - Pan: -100 (full left) to +100 (full right)
- **Tap Point:** Post-Gain (parallel buffer)
- **Status:** ? Implemented (as "GainProcessor")

### **Stage 3: Filter Stage**
- **Purpose:** Remove unwanted frequencies
- **Components:**
  - HPF: 20Hz to 500Hz cutoff (12dB/octave slope)
  - LPF: 2kHz to 20kHz cutoff (12dB/octave slope)
  - Bypass: Enable/disable each filter
- **Tap Point:** Post-Filter (parallel buffer)
- **Status:** ? Not implemented

### **Stage 4: EQ Splitter**
- **Purpose:** Split audio into 5 frequency bands
- **Bands:**
  - Sub: 20-60 Hz (Linkwitz-Riley 4th order)
  - Bass: 60-250 Hz
  - Mid: 250-2000 Hz
  - Treble: 2000-6000 Hz
  - Air: 6000-20000 Hz
- **Algorithm:** Linkwitz-Riley crossover (linear phase)
- **Status:** ? Not implemented

### **Stage 5: 5-Band EQ Processing**
- **Purpose:** Independent EQ for each frequency band
- **Per-Band Controls:**
  - Gain: -12dB to +12dB
  - Bypass: Enable/disable
  - Future: Compressor, limiter
- **Tap Points:** 5 parallel buffers (one per band)
- **Status:** ? Not implemented

### **Stage 6: EQ Mixer**
- **Purpose:** Combine all 5 bands back into stereo
- **Controls:**
  - Per-band level adjustment
  - Crossover slope adjustment
- **Tap Point:** Post-EQ (parallel buffer)
- **Status:** ? Not implemented

### **Stage 7: Output Gain Stage**
- **Purpose:** Master output control
- **Controls:**
  - Master Volume: -60dB to +20dB
  - Output Pan: -100 to +100
  - Stereo Width: 0% (mono) to 200% (wide)
- **Tap Point:** Post-Output-Gain (parallel buffer)
- **Status:** ? Not implemented

### **Stage 8: Output Monitor**
- **Purpose:** Shows final processed audio (what goes to output)
- **Buffer Size:** 2 seconds
- **Used For:** Output meters, FFT analysis
- **Status:** ? Implemented

---

## **?? DSPThread ARCHITECTURE**

### **Current Structure:**

```vb
Class DSPThread
    ' Buffers
    Private inputBuffer As RingBuffer        ' Input from engine
    Private outputBuffer As RingBuffer       ' Output to engine
    Private inputMonitorBuffer As RingBuffer ' Parallel tap (input)
    Private postGainMonitorBuffer As RingBuffer ' Parallel tap (post-gain)
    Private outputMonitorBuffer As RingBuffer ' Parallel tap (output)
    
    ' Processor Chain
    Private chain As ProcessorChain
    
    ' Worker Thread
    Private workerThread As Thread
End Class
```

### **Future Structure (Full DSP Pipeline):**

```vb
Class DSPThread
    ' Buffers
    Private inputBuffer As RingBuffer
    Private outputBuffer As RingBuffer
    
    ' Monitor Buffers (Parallel Taps)
    Private inputMonitorBuffer As RingBuffer         ' ? Implemented
    Private preGainMonitorBuffer As RingBuffer       ' ? To implement
    Private postGainMonitorBuffer As RingBuffer      ' ? Implemented
    Private postFilterMonitorBuffer As RingBuffer    ' ? To implement
    Private eqBand1MonitorBuffer As RingBuffer       ' ? To implement (Sub)
    Private eqBand2MonitorBuffer As RingBuffer       ' ? To implement (Bass)
    Private eqBand3MonitorBuffer As RingBuffer       ' ? To implement (Mid)
    Private eqBand4MonitorBuffer As RingBuffer       ' ? To implement (Treble)
    Private eqBand5MonitorBuffer As RingBuffer       ' ? To implement (Air)
    Private postEQMonitorBuffer As RingBuffer        ' ? To implement
    Private postOutputGainMonitorBuffer As RingBuffer ' ? To implement
    Private outputMonitorBuffer As RingBuffer        ' ? Implemented
    
    ' Processor Chain (Sequential)
    Private preGainProcessor As GainProcessor        ' ? Implemented
    Private hpfProcessor As HighPassFilterProcessor  ' ? To implement
    Private lpfProcessor As LowPassFilterProcessor   ' ? To implement
    Private eqSplitter As EQSplitterProcessor        ' ? To implement
    Private eqBand1 As EQBandProcessor               ' ? To implement
    Private eqBand2 As EQBandProcessor               ' ? To implement
    Private eqBand3 As EQBandProcessor               ' ? To implement
    Private eqBand4 As EQBandProcessor               ' ? To implement
    Private eqBand5 As EQBandProcessor               ' ? To implement
    Private eqMixer As EQMixerProcessor              ' ? To implement
    Private outputGainProcessor As GainProcessor     ' ? To implement
End Class
```

---

## **?? CLARIFICATION: CURRENT VS. TARGET**

### **What We Have NOW (Phase 2):**

```
Mic/File ? RecordingManager/AudioRouter
              ?
         DSPThread
         [Input Monitor] ? Tap
              ?
         GainProcessor (Pre-Gain)
         [Post-Gain Monitor] ? Tap (METERS USE THIS)
              ?
         [Output Monitor] ? Tap
              ?
         Recorder/WaveOut
```

**This is CORRECT for Phase 2!** ?

### **What We're BUILDING TOWARD (Future):**

```
Mic/File ? RecordingManager/AudioRouter
              ?
         DSPThread
         [Input Monitor] ? Tap
              ?
         Pre-Gain ? [Tap]
              ?
         Filters (HPF/LPF) ? [Tap]
              ?
         EQ Splitter (5 bands)
              ?
         ?????????????????????
         ?Sub ?Bass?Mid ?Tre ?Air
         ???????????????????????
           [T]  [T]  [T]  [T] [T] ? Per-band taps
              ?
         EQ Mixer ? [Tap]
              ?
         Output Gain ? [Tap]
              ?
         [Output Monitor] ? Tap
              ?
         Recorder/WaveOut
```

---

## **? CONFIRMATION:**

### **DSP Pipeline Boundaries:**
- **START:** Right after RecordingManager/AudioRouter ?
- **END:** Right before Recorder/WaveOut ?

### **Parallel Tap Pattern:**
- Every stage has parallel monitor buffer ?
- Non-blocking writes to monitor buffers ?
- Meters read from monitor buffers (not main signal path) ?

### **Current Status:**
- Basic pipeline working (Input ? Gain ? Output) ?
- Tap points at input, post-gain, and output ?
- Meters show mic AND file audio ?
- Recording captures DSP-processed audio ?

**Phase 2 is COMPLETE and CORRECT!** ??

**Next phases will add:**
- Filters (Phase 3)
- 5-band EQ (Phase 4)
- Output gain/width controls (Phase 5)

---

## **?? SUMMARY:**

**Your understanding is CORRECT!** The DSP pipeline:
1. Starts after input engine ?
2. Contains stages with tap points ?
3. Each stage has parallel buffer ?
4. Ends before output engine ?
5. Current implementation has basic structure ?
6. Future expansion adds filters/EQ ?

**Is this the architecture you envisioned?** ??

---

**Created:** January 15, 2026  
**Status:** Definitive Specification  
**Phase:** 2 Complete, 3-5 Planned
