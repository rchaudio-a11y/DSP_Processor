# DSP_Processor Audio Signal Flow Architecture v1.3.1.3

**Created:** 2026-01-16  
**Status:** Active (Discovery Phase)  
**RDF Phase:** Phase 2 (Insight Bloom) + Phase 4 (Debugging)  
**Purpose:** Map EVERY buffer, connection, and control in the audio pipeline

---

## ?? Problem Statement

**Issue:** UI sliders (trackGain, trackMaster, etc.) don't affect audio output or meters.

**Root Cause Hypothesis:** Audio signal flow bypasses DSP processors OR meters read from wrong tap points.

**This Document:** Complete architectural map to identify where the signal flow breaks.

---

## ?? Audio Signal Flow (Microphone Path)

### **Source: Microphone Input**

```
???????????????????????????????????????????????????????????????????????
? 1. MICROPHONE CAPTURE                                               ?
?    - WasapiEngine OR MicInputSource                                 ?
?    - Raises: AudioDataAvailable event                               ?
?    - Buffer: e.Buffer (RAW PCM, 16-bit)                            ?
???????????????????????????????????????????????????????????????????????
                              ?
???????????????????????????????????????????????????????????????????????
? 2. RecordingManager.OnAudioDataAvailable()                         ?
?    - Receives: e.Buffer (RAW)                                       ?
?    - Location: Managers/RecordingManager.vb:620                     ?
???????????????????????????????????????????????????????????????????????
                              ?
                    ?????????????????????
                    ?  useDSP = True?   ?
                    ?????????????????????
                              ?
            ?????????????????????????????????????
            ? YES (DSP Enabled)                 ?
            ? Line 628: dspThread.WriteInput()  ?
            ?????????????????????????????????????
                              ?
???????????????????????????????????????????????????????????????????????
? 3. DSPThread Input Buffer                                           ?
?    - Type: CircularBuffer (lock-free)                              ?
?    - Written by: WriteInput(e.Buffer)                              ?
?    - Read by: Worker thread Process()                              ?
???????????????????????????????????????????????????????????????????????
                              ?
???????????????????????????????????????????????????????????????????????
? 4. DSPThread.Process() - Worker Thread                             ?
?    - Reads from: Input buffer                                       ?
?    - Processes through: ProcessorChain                              ?
?    - Writes to: Output buffer                                       ?
?    - Location: DSP/DSPThread.vb                                     ?
???????????????????????????????????????????????????????????????????????
                              ?
???????????????????????????????????????????????????????????????????????
? 5. ProcessorChain (Sequential Processing)                          ?
?    - Processor 1: InputGainProcessor                                ?
?    - Processor 2: OutputGainProcessor                               ?
?    - Each calls: ProcessInternal(buffer)                            ?
?    - Buffer modified IN-PLACE                                       ?
???????????????????????????????????????????????????????????????????????
                              ?
            ?????????????????????????????????????
            ? Tap Points (Monitor Callbacks)    ?
            ? - InputGainProcessor.SendToMonitor ?
            ? - OutputGainProcessor.SendToMonitor?
            ?????????????????????????????????????
                              ?
???????????????????????????????????????????????????????????????????????
? 6. DSPThread Monitor Buffers (Ring Buffers)                        ?
?    - postGainMonitorBuffer (after InputGainProcessor)              ?
?    - postOutputGainMonitorBuffer (after OutputGainProcessor)       ?
?    - Written by: SendToMonitor() callbacks                          ?
???????????????????????????????????????????????????????????????????????
                              ?
???????????????????????????????????????????????????????????????????????
? 7. DSPThread Output Buffer                                          ?
?    - Type: CircularBuffer                                           ?
?    - Contains: PROCESSED audio (after both gain stages)             ?
?    - Read by: Line 635 dspThread.ReadOutput(drainBuffer)           ?
???????????????????????????????????????????????????????????????????????
                              ?
???????????????????????????????????????????????????????????????????????
? 8. Recording Path (if recording)                                    ?
?    - Uses: drainBuffer (PROCESSED audio)                            ?
?    - Line 638: recorder.ProcessBuffer(drainBuffer)                  ?
?    - Result: Recorded file HAS gain applied                         ?
???????????????????????????????????????????????????????????????????????
```

---

## ?? **THE PROBLEM: Metering & Monitoring Bypass DSP!**

### **Line 659-665: BufferAvailable Event (BYPASSES DSP!)**

```visualbasic
' Always raise BufferAvailable for FFT/metering (use raw buffer)
Dim args As New AudioBufferEventArgs With {
    .Buffer = e.Buffer,  ' ? RAW BUFFER FROM MIC, NOT PROCESSED!
    .BitsPerSample = mic.BitsPerSample,
    .Channels = mic.Channels,
    .SampleRate = mic.SampleRate
}
RaiseEvent RecordingBufferAvailable(Me, args)
```

**This means:**
- ? Meters see RAW audio (before GainProcessor)
- ? FFT sees RAW audio (before GainProcessor)  
- ? UI updates show unprocessed levels
- ? Moving trackGain slider changes NOTHING you see!

**But:**
- ? Recording DOES get processed audio (uses drainBuffer)
- ? GainProcessor IS in the chain and DOES process audio

---

## ?? Control ? Processor Wiring

### **1. AudioPipelinePanel Sliders**

| Control | Property | Target Processor | Method | Line |
|---------|----------|------------------|--------|------|
| `trkInputGain` | Value (0-200%) | `RecordingManager.InputGainProcessor` | `.GainLinear` | AudioPipelinePanel.vb:511 |
| `trkOutputGain` | Value (0-200%) | `RecordingManager.OutputGainProcessor` | `.GainLinear` | AudioPipelinePanel.vb:532 |

**Wiring:**
- MainForm.vb:246 - `AudioPipelinePanel1.SetRecordingManager(recordingManager)`

**Status:** ? WIRED correctly (as of today's fix)

---

### **2. DSPSignalFlowPanel Sliders**

| Control | Property | Target Processor | Method | Line |
|---------|----------|------------------|--------|------|
| `trackGain` | Value (-600 to +200) | `gainProcessor` (reference) | `.GainDB` | DSPSignalFlowPanel.vb:254 |
| `trackPan` | Value (-100 to +100) | `gainProcessor` (reference) | `.PanPosition` | DSPSignalFlowPanel.vb:276 |
| `trackMaster` | Value | ? NOT IMPLEMENTED | None | DSPSignalFlowPanel.vb:323 |
| `trackWidth` | Value | ? NOT IMPLEMENTED | None | DSPSignalFlowPanel.vb:335 |

**Wiring:**
- MainForm.vb:447 - `DspSignalFlowPanel1.SetGainProcessor(recordingManager.InputGainProcessor)`
- **Triggered by:** OnMicrophoneArmed event (line 439)

**Status:** ?? WIRED but user can't see effect (meters show raw audio)

---

## ??? Meter ? Data Source Wiring

### **MainForm Meters**

| Meter Control | Data Source | Buffer Used | Line |
|---------------|-------------|-------------|------|
| `meterRecording1` | `OnRecordingBufferAvailable` | `e.Buffer` (RAW!) | MainForm.vb:420-436 |
| `meterPlayback1` | `OnPlaybackBufferAvailable` | AudioRouter output | MainForm.vb:??? |

**Problem:** Line 420 receives `RecordingBufferAvailable` event with RAW buffer!

---

### **DSPSignalFlowPanel Meters**

| Meter Control | Data Source | Status |
|---------------|-------------|--------|
| `meterInputLeft` | ? NOT CONNECTED | Never updates |
| `meterInputRight` | ? NOT CONNECTED | Never updates |
| `meterOutputLeft` | ? NOT CONNECTED | Never updates |
| `meterOutputRight` | ? NOT CONNECTED | Never updates |

**Method:** `UpdateMeters(inputLeftDb, inputRightDb, outputLeftDb, outputRightDb)` exists but never called!

---

## ?? Event Subscription Chain

### **RecordingManager Events**

```visualbasic
' RecordingManager.vb:665 - Raises this event:
RaiseEvent RecordingBufferAvailable(Me, args)  ' ? RAW buffer!

' MainForm.vb:??? - Subscribes:
AddHandler recordingManager.RecordingBufferAvailable, AddressOf OnRecordingBufferAvailable

' MainForm.vb:420 - Handles:
Private Sub OnRecordingBufferAvailable(sender As Object, e As AudioBufferEventArgs)
    ' ... calculates levelData from e.Buffer (RAW!)
    meterRecording1.UpdateLevel(levelData.PeakDB, levelData.RMSDB, levelData.IsClipping)
End Sub
```

**Chain:** Mic ? RAW buffer ? Event ? Meter  
**Problem:** DSP is BYPASSED!

---

## ?? DSP Tap Points (Available but UNUSED!)

### **Monitor Buffers in DSPThread**

| Tap Point | Ring Buffer | Written By | Read By |
|-----------|-------------|------------|---------|
| `postGainMonitorBuffer` | Multi-reader ring buffer | `InputGainProcessor.SendToMonitor()` | ? NOBODY! |
| `postOutputGainMonitorBuffer` | Multi-reader ring buffer | `OutputGainProcessor.SendToMonitor()` | ? NOBODY! |

**These buffers contain PROCESSED audio but are NEVER READ!**

---

## ?? Invariants (What SHOULD Be True)

### **Sacred Rules:**

1. **Audio Processing is Sequential:**  
   Mic ? Input Buffer ? InputGainProcessor ? OutputGainProcessor ? Output Buffer

2. **Tap Points Are Post-Processing:**  
   Each processor's `SendToMonitor()` fires AFTER processing

3. **Meters Should Show Processed Audio:**  
   Meters should read from tap point buffers, NOT raw input

4. **Sliders Should Control Processors:**  
   Moving slider ? Updates processor property ? Audio changes ? Meters reflect change

### **Current Violations:**

? **Invariant #3 BROKEN:** Meters read from RAW buffer (line 661)  
? **Invariant #4 BROKEN:** Slider changes aren't visible (because meters show raw)  
?? **Invariant #2 QUESTIONABLE:** Tap point buffers exist but unused

---

## ?? The Fix Strategy

### **Option 1: Use Tap Point Buffers** ? (Recommended)

**Change RecordingBufferAvailable to read from tap points:**

```visualbasic
' Instead of line 660-665 (raw buffer):
Dim args As New AudioBufferEventArgs With {
    .Buffer = e.Buffer,  ' ? RAW

' Use this (processed buffer from tap point):
Dim processedBuffer(???) As Byte
dspThread.ReadFromTapPoint(TapPoint.PostOutputGain, processedBuffer)
Dim args As New AudioBufferEventArgs With {
    .Buffer = processedBuffer,  ' ? PROCESSED
```

**Pros:**
- ? Meters show processed audio
- ? Sliders become visible in meters
- ? Uses existing tap point architecture
- ? Correct architectural pattern

**Cons:**
- ?? Need to implement `ReadFromTapPoint()` method
- ?? Slightly more complex

---

### **Option 2: Use drainBuffer** (Quick Fix)

**Use the already-read drainBuffer:**

```visualbasic
' Line 635: We already drained processed output
Dim bytesRead = dspThread.ReadOutput(drainBuffer, 0, drainBuffer.Length)

' Line 659: Instead of using e.Buffer (raw), use drainBuffer (processed)
Dim args As New AudioBufferEventArgs With {
    .Buffer = drainBuffer,  ' ? PROCESSED
    .ByteCount = bytesRead  ' ? Actual bytes read
```

**Pros:**
- ? Simple, no new code needed
- ? Meters immediately show processed audio
- ? Minimal change

**Cons:**
- ? Not the "proper" tap point pattern
- ? Couples metering to output drain timing

---

## ?? Recommendation

**Implement Option 2 (drainBuffer) NOW for immediate fix, then refactor to Option 1 (tap points) in next iteration.**

**Why:**
- Gets sliders working TODAY
- Proves the hypothesis (meters bypass DSP)
- Can refactor to proper tap points in Phase 3.1.4

---

## ?? Next Steps

1. ? **Phase 4 Complete:** Root cause identified (meters bypass DSP)
2. ? **Phase 3 (Build):** Implement drainBuffer fix
3. ? **Phase 5 (Validate):** Test slider control works
4. ? **Phase 6 (Synthesis):** Document and refactor to tap points

---

## ?? Related Files

**Audio Flow:**
- `Managers/RecordingManager.vb:620-665` - OnAudioDataAvailable (THE PROBLEM)
- `DSP/DSPThread.vb` - Worker thread, ProcessorChain
- `DSP/GainProcessor.vb:87-161` - ProcessInternal, SendToMonitor

**UI Controls:**
- `UI/DSPSignalFlowPanel.vb:237-262` - trackGain event handlers
- `UI/TabPanels/AudioPipelinePanel.vb:505-537` - Input/Output gain sliders
- `MainForm.vb:420-436` - OnRecordingBufferAvailable (meter updates)

**Wiring:**
- `MainForm.vb:439-454` - OnMicrophoneArmed (wires DSPSignalFlowPanel)
- `MainForm.vb:242-252` - WireAudioPipelinePanel (injects RecordingManager)

---

**Document Version:** 1.0  
**Last Updated:** 2026-01-16  
**Author:** Rick + GitHub Copilot (RDF Pair Programming)  
**Status:** Active - Ready for Phase 3 (Implement Fix)
