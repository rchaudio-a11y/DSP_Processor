Imports NAudio.Wave

Namespace AudioIO

    ''' <summary>
    ''' Audio engine implementation for WaveIn (Windows WDM drivers).
    ''' Wraps NAudio WaveInEvent to provide IAudioEngine interface.
    ''' </summary>
    ''' <remarks>
    ''' Created: Phase 1, Task 1.1
    ''' Purpose: Provide consistent API across different audio driver types
    ''' Note: This is a simplified implementation. Full wrapper will be completed when
    ''' MicInputSource is refactored to expose standard Start/Stop/Events pattern.
    ''' </remarks>
    Public Class WaveInEngine
        Implements IAudioEngine

#Region "Private Fields"

        Private _waveIn As WaveInEvent
        Private _deviceInfo As DeviceInfo
        Private _disposed As Boolean = False
        Private _sampleRate As Integer = 44100
        Private _channels As Integer = 2
        Private _bitsPerSample As Integer = 16
        Private _bufferMs As Integer = 30

#End Region

#Region "Properties"

        ''' <summary>Gets whether audio is currently being captured</summary>
        Public ReadOnly Property IsRecording As Boolean Implements IAudioEngine.IsRecording
            Get
                Return _waveIn IsNot Nothing
            End Get
        End Property

        ''' <summary>Gets the audio sample rate in Hz</summary>
        Public ReadOnly Property SampleRate As Integer Implements IAudioEngine.SampleRate
            Get
                Return _sampleRate
            End Get
        End Property

        ''' <summary>Gets the number of audio channels</summary>
        Public ReadOnly Property Channels As Integer Implements IAudioEngine.Channels
            Get
                Return _channels
            End Get
        End Property

        ''' <summary>Gets the bit depth per sample</summary>
        Public ReadOnly Property BitsPerSample As Integer Implements IAudioEngine.BitsPerSample
            Get
                Return _bitsPerSample
            End Get
        End Property

        ''' <summary>Gets the actual measured latency in milliseconds</summary>
        Public ReadOnly Property Latency As Integer Implements IAudioEngine.Latency
            Get
                Return _bufferMs
            End Get
        End Property

        ''' <summary>Gets the latency in milliseconds (Task 1.1 addition)</summary>
        Public ReadOnly Property LatencyMS As Integer Implements IAudioEngine.LatencyMS
            Get
                Return _bufferMs
            End Get
        End Property

        ''' <summary>Gets the audio engine name</summary>
        Public ReadOnly Property EngineName As String Implements IAudioEngine.EngineName
            Get
                Return "WaveIn"
            End Get
        End Property

        ''' <summary>Gets the driver type (Task 1.1 addition)</summary>
        Public ReadOnly Property DriverType As DriverType Implements IAudioEngine.DriverType
            Get
                Return AudioIO.DriverType.WaveIn
            End Get
        End Property

        ''' <summary>Gets the list of supported devices (Task 1.1 addition)</summary>
        Public ReadOnly Property SupportedDevices As IEnumerable(Of DeviceInfo) Implements IAudioEngine.SupportedDevices
            Get
                Return AudioInputManager.Instance.GetDevices(AudioIO.DriverType.WaveIn)
            End Get
        End Property

#End Region

#Region "Events"

        ''' <summary>Raised when audio data is available</summary>
        Public Event DataAvailable As EventHandler(Of AudioDataEventArgs) Implements IAudioEngine.DataAvailable

        ''' <summary>Raised when recording stops</summary>
        Public Event RecordingStopped As EventHandler(Of StoppedEventArgs) Implements IAudioEngine.RecordingStopped

#End Region

#Region "Constructor"

        ''' <summary>
        ''' Creates a new WaveInEngine for the specified device
        ''' </summary>
        Public Sub New(deviceInfo As DeviceInfo, sampleRate As Integer, channels As Integer, bitsPerSample As Integer, Optional bufferMs As Integer = 30)
            If deviceInfo Is Nothing Then
                Throw New ArgumentNullException(NameOf(deviceInfo))
            End If

            If deviceInfo.DriverType <> AudioIO.DriverType.WaveIn Then
                Throw New ArgumentException("DeviceInfo must be for WaveIn driver type")
            End If

            _deviceInfo = deviceInfo
            _sampleRate = sampleRate
            _channels = channels
            _bitsPerSample = bitsPerSample
            _bufferMs = bufferMs

            Utils.Logger.Instance.Info($"WaveInEngine created for device: {deviceInfo.Name}", "WaveInEngine")
        End Sub

        ''' <summary>
        ''' Creates a new WaveInEngine with default device and settings
        ''' </summary>
        Public Sub New()
            Dim defaultDevice = AudioInputManager.Instance.GetDefaultDevice(AudioIO.DriverType.WaveIn)
            If defaultDevice Is Nothing Then
                ' Create a basic device info if no devices found
                defaultDevice = New DeviceInfo("Default WaveIn Device", "WaveIn_0", AudioIO.DriverType.WaveIn) With {
                    .DeviceIndex = 0
                }
            End If

            _deviceInfo = defaultDevice
            Utils.Logger.Instance.Info("WaveInEngine created with default settings", "WaveInEngine")
        End Sub

#End Region

#Region "Methods"

        ''' <summary>
        ''' Starts capturing audio
        ''' </summary>
        Public Sub Start() Implements IAudioEngine.Start
            If _waveIn Is Nothing Then
                ' Create WaveInEvent with specified format
                _waveIn = New WaveInEvent() With {
                    .DeviceNumber = _deviceInfo.DeviceIndex,
                    .WaveFormat = New WaveFormat(_sampleRate, _bitsPerSample, _channels),
                    .BufferMilliseconds = _bufferMs,
                    .NumberOfBuffers = 3
                }

                ' Wire up events
                AddHandler _waveIn.DataAvailable, AddressOf OnWaveInDataAvailable
                AddHandler _waveIn.RecordingStopped, AddressOf OnWaveInRecordingStopped
            End If

            _waveIn.StartRecording()
            Utils.Logger.Instance.Debug("WaveInEngine started", "WaveInEngine")
        End Sub

        ''' <summary>
        ''' Stops capturing audio
        ''' </summary>
        Public Sub [Stop]() Implements IAudioEngine.Stop
            If _waveIn IsNot Nothing Then
                _waveIn.StopRecording()
                Utils.Logger.Instance.Debug("WaveInEngine stopped", "WaveInEngine")
            End If
        End Sub

        ''' <summary>
        ''' Checks if this engine supports exclusive mode (always false for WaveIn)
        ''' </summary>
        Public Function SupportsExclusiveMode() As Boolean Implements IAudioEngine.SupportsExclusiveMode
            Return False ' WaveIn always uses shared mode
        End Function

        ''' <summary>
        ''' Gets the optimal buffer size for WaveIn
        ''' </summary>
        ''' <returns>Recommended buffer size in samples</returns>
        Public Function GetOptimalBufferSize() As Integer Implements IAudioEngine.GetOptimalBufferSize
            ' WaveIn works best with ~30-50ms buffers
            ' At 44100 Hz, 30ms = 1323 samples
            Dim targetMs = 30
            Dim samplesPerMs = _sampleRate / 1000
            Return targetMs * samplesPerMs
        End Function

#End Region

#Region "Event Handlers"

        ''' <summary>
        ''' Forwards DataAvailable event from WaveInEvent
        ''' </summary>
        Private Sub OnWaveInDataAvailable(sender As Object, e As WaveInEventArgs)
            ' Convert WaveInEventArgs to AudioDataEventArgs
            Dim audioData As New AudioDataEventArgs(e.Buffer, e.BytesRecorded)
            RaiseEvent DataAvailable(Me, audioData)
        End Sub

        ''' <summary>
        ''' Forwards RecordingStopped event from WaveInEvent
        ''' </summary>
        Private Sub OnWaveInRecordingStopped(sender As Object, e As NAudio.Wave.StoppedEventArgs)
            ' Convert NAudio.Wave.StoppedEventArgs to our StoppedEventArgs if needed
            Dim args = New StoppedEventArgs(e.Exception)
            RaiseEvent RecordingStopped(Me, args)
        End Sub

#End Region

#Region "IDisposable Implementation"

        Public Sub Dispose() Implements IDisposable.Dispose
            If Not _disposed Then
                If _waveIn IsNot Nothing Then
                    RemoveHandler _waveIn.DataAvailable, AddressOf OnWaveInDataAvailable
                    RemoveHandler _waveIn.RecordingStopped, AddressOf OnWaveInRecordingStopped
                    _waveIn.Dispose()
                    _waveIn = Nothing
                End If

                _disposed = True
                Utils.Logger.Instance.Info("WaveInEngine disposed", "WaveInEngine")
            End If
        End Sub

#End Region

    End Class

End Namespace

